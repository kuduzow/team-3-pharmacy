# Командный проект: бекенд для приложения аптеки

## Постановка задачи

Ты и твоя команда разрабатываете бекенд для онлайн‑аптеки.  
Фронтенд‑команда ждёт от вас удобный и предсказуемый REST API, через который можно:

- управлять каталогом лекарств и их категориями;
- работать с корзиной пользователя;
- оформлять заказы и платежи;
- применять промокоды;
- оставлять отзывы к лекарствам.

Цель проекта — не просто запустить сервер, а спроектировать аккуратную доменную модель, продуманную бизнес‑логику и API, с которым удобно работать другим разработчикам.

Перед тем как писать код, внимательно дочитай этот файл до конца, обсуди требования с командой и только потом начинайте реализацию.

Здесь приведены общие требования к серверу. Команда вправе решать какие дополнительные сущности, эндпоинты, модели и т.д. вводить. Также разрешается урезать какой-то функционал, чтобы не расстягивать разработку по времени.

Порядок выпуска релизов также должен быть обговорен командой.

В каждом коммите рекомендуется делать небольшую, но завершенную работу. Например подготовить все модели по одной сущности, или все репозитории для одной сущности.

Репозиторий в гитхаб должен быть создан преподавателем. Каждая доработка должна попадать в проект в виде Pull Request. После создания PR преподватель сделает код-ревью, после чего либо примет работу либо напишет замечения.

Рекомендуется сущности Заказа, Корзины и Промокода сделать в последнюю очередь.

## Требования к архитектуре

Эталонный пример архитектуры можно посмотреть в проекте https://github.com/intocode/intocode-backend-api-sample.  
Новый проект для аптеки должен придерживаться тех же принципов:

- **Разделение на слои:**
  - **transport (HTTP‑слой, хендлеры)** — отвечает за работу с `gin.Context`, чтение параметров/тела запроса, выбор правильного HTTP‑кода и формирование JSON‑ответа;
  - **services (бизнес‑логика)** — содержит сценарии предметной области (проверка остатков, применение промокодов, изменение статуса заказа, валидация входных данных и т.п.);
  - **repository (работа с базой данных)** — отвечает за чтение/запись сущностей в БД;
  - **models (доменные модели и DTO)** — структуры сущностей и отдельные структуры для запросов/ответов (например, `Medicine`, `MedicineCreateRequest`, `MedicineUpdateRequest`).
- **Взаимодействие между слоями:**
  - transport обращается только к сервисам (через интерфейсы);
  - сервисы используют репозитории и другие сервисы;
  - репозитории работают с базой данных и не знают о HTTP.
- **Валидация и бизнес‑правила** должны находиться на уровне сервисов (по аналогии с `StudentService` в эталонном проекте).
- Для создания и обновления сущностей используй отдельные DTO‑структуры, как в примере `StudentCreateRequest` и `StudentUpdateRequest`.
- Все HTTP‑ответы — в формате JSON. При ошибке сервер возвращает объект вида:

```json
{ "error": "человеко-понятное описание ошибки" }
```

## Сущности и бизнес‑требования

Всё ниже — минимальный набор требований. Команда может расширять модели и сценарии, если это не ломает базовую логику.

### Пользователь (User)

Пользователь — это клиент аптеки.

- Пример полей:
  - `id` — уникальный идентификатор;
  - `full_name` — полное имя;
  - `email` — e‑mail;
  - `phone` — телефон;
  - `default_address` — адрес доставки по умолчанию;
  - `created_at`, `updated_at`.
- Пользователь может:
  - просматривать каталог лекарств и детали по каждому лекарству;
  - добавлять лекарства в корзину, менять количество, удалять позиции;
  - оформлять заказ на основе своей корзины;
  - применять промокод к заказу;
  - оплачивать заказ одним или несколькими платежами;
  - просматривать историю своих заказов и деталей по каждому;
  - оставлять отзывы к уже купленным лекарствам.

Авторизацию и регистрацию делать не нужно.

### Лекарство (Medicine)

Лекарство — основной товар в системе.

- Пример полей:
  - `id`;
  - `name` — название;
  - `description` — описание;
  - `price` — цена в минимальных единицах (например, копейках);
  - `in_stock` — есть ли товар в наличии;
  - `stock_quantity` — остаток на складе;
  - `category_id` — категория;
  - `subcategory_id` — подкатегория;
  - `manufacturer` — производитель;
  - `prescription_required` — требуется ли рецепт;
  - `avg_rating` — средняя оценка по отзывам (только для чтения, вычисляется на основе отзывов).
- Требования:
  - сервер должен позволять создавать, редактировать, удалять и получать лекарства;
  - нельзя добавить в корзину больше единиц, чем есть на складе;
  - при изменении цены или статуса наличия информация должна корректно отражаться в списках и карточках.

### Категории и подкатегории

Лекарства группируются по категориям и подкатегориям.

- Возможная модель:
  - `Category`: `id`, `name`;
  - `Subcategory`: `id`, `category_id`, `name`.
- Требования:
  - можно получить список всех категорий;
  - можно получить список подкатегорий для конкретной категории;
  - можно получить список лекарств для выбранной категории/подкатегории.

### Корзина (Cart)

У каждого пользователя есть своя корзина.

- Корзина содержит список позиций:
  - `medicine_id`;
  - `quantity`;
  - `price_per_unit` (фиксируется на момент добавления в корзину);
  - `line_total` (рассчитанная стоимость позиции).
- Требования:
  - пользователь может добавить лекарство в корзину (если оно в наличии);
  - можно изменить количество или убрать позицию из корзины;
  - сервер возвращает текущее состояние корзины и итоговую сумму;
  - при оформлении заказа корзина «привязывается» к заказу и очищается.

### Заказ (Order)

Заказ фиксирует содержимое корзины на момент оформления и статусы его обработки.

- Пример полей:
  - `id`;
  - `user_id`;
  - `status` — например: `draft`, `pending_payment`, `paid`, `canceled`, `shipped`, `completed`;
  - `total_price` — сумма без скидок;
  - `discount_total` — общая сумма скидки;
  - `final_price` — сумма к оплате с учётом промокода;
  - `delivery_address` — адрес доставки на момент заказа;
  - `comment` — комментарий покупателя;
  - `created_at`, `updated_at`.
- Позиции заказа (отдельная сущность/таблица):
  - `order_id`;
  - `medicine_id`;
  - `medicine_name` (копия названия на момент заказа);
  - `quantity`;
  - `price_per_unit`;
  - `line_total`.
- Требования:
  - заказ создаётся на основе текущей корзины пользователя;
  - после успешного создания заказа корзина очищается;
  - статус заказа меняется по понятной бизнес‑логике (например, из `pending_payment` в `paid` после успешного платежа);
  - нельзя пометить заказ как `paid`, если сумма успешных платежей меньше `final_price`.

### Платёж (Payment)

Платёж отражает факт оплаты по заказу.

- Пример полей:
  - `id`;
  - `order_id`;
  - `amount` — сумма платежа;
  - `status` — например: `pending`, `success`, `failed`;
  - `method` — `card`, `cash`, `online_wallet` и т.п.;
  - `paid_at` — время успешного платежа.
- Требования:
  - к одному заказу может быть привязано несколько платежей;
  - общая сумма успешных платежей не может превышать `final_price` заказа;
  - при успешном платеже статус заказа и агрегированные поля (`paid_amount`, `payment_status` и т.п.) должны обновляться на уровне сервиса;
  - должна быть возможность получить историю платежей по конкретному заказу.

### Отзыв к лекарству (Review)

Отзыв привязан к лекарству и пользователю.

- Пример полей:
  - `id`;
  - `user_id`;
  - `medicine_id`;
  - `rating` — целое число от 1 до 5;
  - `text` — текст отзыва;
  - `created_at`.
- Требования:
  - пользователь может оставить отзыв только к тем лекарствам, которые он заказывал;
  - должна быть возможность получить список отзывов по конкретному лекарству;
  - средняя оценка лекарства (`avg_rating`) считается по всем отзывам;
  - отзыв можно отредактировать или удалить.

### Промокод (Promocode)

Промокод позволяет снизить итоговую стоимость заказа.

- Пример полей:
  - `id`;
  - `code` — строковый код (например, `SPRING2025`);
  - `description`;
  - `discount_type` — `percent` или `fixed`;
  - `discount_value` — размер скидки (процент или фиксированная сумма);
  - `valid_from`, `valid_to` — период действия;
  - `max_uses` — необязательное ограничение общего количества использований;
  - `max_uses_per_user` — необязательное ограничение на пользователя;
  - `is_active` — включён/выключен.
- Требования:
  - сервер должен уметь проверять промокод (дата, активность, лимиты);
  - скидка не может сделать итоговую сумму отрицательной;
  - применение промокода влияет на поля `discount_total` и `final_price` заказа.

## REST API

Ниже приведён минимальный набор маршрутов. Команда может добавлять дополнительные эндпоинты, но базовые сценарии должны быть реализованы.

Во всех примерах:

- тело запроса и ответа в формате JSON;
- при ошибке возвращается объект `{ "error": "..." }` и соответствующий HTTP‑статус (`400`, `404`, `500` и т.п.).

### Лекарства

- **GET `/medicines`** — список лекарств.
  - Query‑параметры (опционально): `search`, `category_id`, `subcategory_id`, `in_stock`.
  - Пример ответа:

```json
[
  {
    "id": 1,
    "name": "Парацетамол",
    "price": 15000,
    "in_stock": true,
    "avg_rating": 4.6
  }
]
```

- **GET `/medicines/:id`** — подробная информация о лекарстве.

```json
{
  "id": 1,
  "name": "Парацетамол",
  "description": "Жаропонижающее средство",
  "price": 15000,
  "in_stock": true,
  "stock_quantity": 42,
  "category_id": 3,
  "subcategory_id": 7,
  "manufacturer": "ООО Фарм",
  "prescription_required": false,
  "avg_rating": 4.6
}
```

- **POST `/medicines`** — создание лекарства.

```json
{
  "name": "Парацетамол",
  "description": "Жаропонижающее средство",
  "price": 15000,
  "in_stock": true,
  "stock_quantity": 100,
  "category_id": 3,
  "subcategory_id": 7,
  "manufacturer": "ООО Фарм",
  "prescription_required": false
}
```

Ответ: созданное лекарство с `id` и служебными полями (`201 Created`).

- **PATCH `/medicines/:id`** — частичное обновление лекарства (все поля необязательны).

```json
{
  "price": 16000,
  "in_stock": false,
  "stock_quantity": 0
}
```

- **DELETE `/medicines/:id`** — удаление лекарства.

### Категории и подкатегории

- **GET `/categories`** — список категорий.
- **POST `/categories`** — создать категорию.
- **GET `/categories/:id/subcategories`** — список подкатегорий для категории.
- **POST `/categories/:id/subcategories`** — создать подкатегорию внутри категории.
- Дополнительно можно реализовать редактирование и удаление категорий/подкатегорий.

### Пользователи

- **POST `/users`** — создание пользователя.

```json
{
  "full_name": "Иван Иванов",
  "email": "ivan@example.com",
  "phone": "+79990001122",
  "default_address": "Москва, ул. Примерная, д. 1"
}
```

- **GET `/users/:id`** — получить данные пользователя.
- **GET `/users/:id/orders`** — история заказов пользователя.
- **GET `/users/:id/cart`** — текущая корзина пользователя.

### Корзина

Все операции с корзиной привязаны к конкретному пользователю.

- **GET `/users/:id/cart`** — текущее состояние корзины.

```json
{
  "user_id": 1,
  "items": [
    {
      "item_id": 10,
      "medicine_id": 5,
      "name": "Парацетамол",
      "quantity": 2,
      "price_per_unit": 15000,
      "line_total": 30000
    }
  ],
  "total_price": 30000
}
```

- **POST `/users/:id/cart/items`** — добавить позицию в корзину или увеличить количество, если такая позиция уже есть.

```json
{
  "medicine_id": 5,
  "quantity": 2
}
```

Ответ: обновлённая корзина.

- **PATCH `/users/:id/cart/items/:item_id`** — изменить количество позиции.

```json
{
  "quantity": 1
}
```

- **DELETE `/users/:id/cart/items/:item_id`** — удалить позицию из корзины.
- **DELETE `/users/:id/cart`** — очистить корзину полностью.

Сервисный слой должен контролировать, что `quantity` положительное и не превышает остаток на складе.

### Заказы

- **POST `/users/:id/orders`** — создать новый заказ на основе текущей корзины пользователя.

```json
{
  "delivery_address": "Москва, ул. Примерная, д. 1",
  "comment": "Позвонить за 30 минут до доставки",
  "promocode": "SPRING2025"
}
```

Ответ (`201 Created`): заказ с позициями, ценами, применённой скидкой и статусом `pending_payment`.

- **GET `/orders/:id`** — получить детали заказа (включая позиции и платежи).
- **GET `/users/:id/orders`** — список заказов пользователя (короткая информация).
- **PATCH `/orders/:id/status`** — изменить статус заказа (например, для админ‑панели).

```json
{
  "status": "shipped"
}
```

Сервис должен проверять допустимость переходов между статусами.

### Платежи

- **POST `/orders/:id/payments`** — создать платёж по заказу.

```json
{
  "amount": 30000,
  "method": "card"
}
```

Ответ: созданный платёж и обновлённое состояние заказа (например, суммарно оплачено и новый `payment_status`).

- **GET `/orders/:id/payments`** — список платежей по заказу.
- **GET `/payments/:id`** — один платёж.
- При необходимости можно добавить **DELETE `/payments/:id`** для удаления/отмены платежа (с пересчётом агрегированных полей заказа).

Сервисный слой должен проверять, что `amount > 0` и что суммарные успешные платежи не превышают `final_price`.

### Промокоды

- **GET `/promocodes`** — список промокодов (для админ‑части).
- **POST `/promocodes`** — создать промокод.

```json
{
  "code": "SPRING2025",
  "description": "Весенняя скидка 10%",
  "discount_type": "percent",
  "discount_value": 10,
  "valid_from": "2025-03-01T00:00:00Z",
  "valid_to": "2025-03-31T23:59:59Z",
  "is_active": true
}
```

- **PATCH `/promocodes/:id`** — частичное обновление промокода.
- **DELETE `/promocodes/:id`** — деактивация/удаление промокода.
- Дополнительно можно сделать эндпоинт проверки:
  - **POST `/promocodes/validate`** с телом `{ "code": "SPRING2025", "order_amount": 50000 }` и ответом с рассчитанной скидкой.

### Отзывы

- **GET `/medicines/:id/reviews`** — список отзывов к лекарству.
- **POST `/medicines/:id/reviews`** — добавить отзыв.

```json
{
  "user_id": 1,
  "rating": 5,
  "text": "Хорошо помог, без побочных эффектов"
}
```

- **PATCH `/reviews/:id`** — частично изменить отзыв (например, текст или оценку).
- **DELETE `/reviews/:id`** — удалить отзыв.

Сервисный слой должен проверять, что `rating` в диапазоне от 1 до 5 и что пользователь действительно покупал это лекарство.